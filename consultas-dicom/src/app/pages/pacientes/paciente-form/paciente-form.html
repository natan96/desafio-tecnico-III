<div class="container-fluid py-4">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="d-flex align-items-center mb-4">
        <button
          type="button"
          class="btn btn-link text-decoration-none me-3"
          (click)="router.navigate(['/pacientes'])"
        >
          <i class="fas fa-arrow-left"></i>
        </button>
        <h2 class="mb-0">
          <i class="fas fa-user-plus me-2"></i>
          {{ isEditing ? 'Editar Paciente' : 'Novo Paciente' }}
        </h2>
      </div>

      <div class="card shadow-sm">
        <div class="card-body p-4">
          @if (networkError) {
            <div class="alert alert-danger d-flex align-items-center justify-content-between mb-4">
              <div>
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Erro de conexão.</strong> Não foi possível carregar os dados do paciente.
                Verifique sua internet e tente novamente.
              </div>
              <button type="button" class="btn btn-danger" (click)="loadPaciente(pacienteId!)">
                <i class="fas fa-redo me-2"></i>Tentar Novamente
              </button>
            </div>
          }
          <form [formGroup]="form" (ngSubmit)="onSubmit()">
            <!-- Dados Pessoais -->
            <h5 class="mb-3 text-primary"><i class="fas fa-user me-2"></i>Dados Pessoais</h5>
            <div class="row">
              <div class="col-md-12 mb-3">
                <label class="form-label">Nome <span class="text-danger">*</span></label>
                <input
                  type="text"
                  class="form-control"
                  formControlName="nome"
                  [class.is-invalid]="isFieldInvalid('nome')"
                  placeholder="Nome completo"
                />
                @if (isFieldInvalid('nome')) {
                  <div class="invalid-feedback">{{ getFieldError('nome') }}</div>
                }
              </div>

              <div class="col-md-4 mb-3">
                <label class="form-label">CPF <span class="text-danger">*</span></label>
                <input
                  type="text"
                  class="form-control"
                  formControlName="documento"
                  mask="000.000.000-00"
                  [dropSpecialCharacters]="true"
                  [class.is-invalid]="isFieldInvalid('documento')"
                  placeholder="000.000.000-00"
                />
                @if (isFieldInvalid('documento')) {
                  <div class="invalid-feedback">{{ getFieldError('documento') }}</div>
                }
              </div>

              <div class="col-md-4 mb-3">
                <label class="form-label">Celular <span class="text-danger">*</span></label>
                <input
                  type="text"
                  class="form-control"
                  formControlName="celular"
                  mask="(00) 00000-0000"
                  [dropSpecialCharacters]="true"
                  [class.is-invalid]="isFieldInvalid('celular')"
                  placeholder="(00) 00000-0000"
                />
                @if (isFieldInvalid('celular')) {
                  <div class="invalid-feedback">{{ getFieldError('celular') }}</div>
                }
              </div>

              <div class="col-md-4 mb-3">
                <label class="form-label"
                  >Data de Nascimento <span class="text-danger">*</span></label
                >
                <input
                  type="date"
                  class="form-control"
                  formControlName="dataNascimento"
                  [max]="maxDate"
                  [class.is-invalid]="isFieldInvalid('dataNascimento')"
                />
                @if (isFieldInvalid('dataNascimento')) {
                  <div class="invalid-feedback">{{ getFieldError('dataNascimento') }}</div>
                }
              </div>
            </div>

            <!-- Endereço -->
            <h5 class="mb-3 text-primary mt-4">
              <i class="fas fa-map-marker-alt me-2"></i>Endereço
            </h5>
            <div class="row">
              <div class="col-md-3 mb-3">
                <label class="form-label">CEP <span class="text-danger">*</span></label>
                <input
                  type="text"
                  class="form-control"
                  formControlName="cep"
                  mask="00000-000"
                  [dropSpecialCharacters]="true"
                  [class.is-invalid]="isFieldInvalid('cep')"
                  placeholder="00000-000"
                />
                @if (isFieldInvalid('cep')) {
                  <div class="invalid-feedback">{{ getFieldError('cep') }}</div>
                }
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label">Rua <span class="text-danger">*</span></label>
                <input
                  type="text"
                  class="form-control"
                  formControlName="rua"
                  [class.is-invalid]="isFieldInvalid('rua')"
                  placeholder="Nome da rua"
                />
                @if (isFieldInvalid('rua')) {
                  <div class="invalid-feedback">{{ getFieldError('rua') }}</div>
                }
              </div>

              <div class="col-md-3 mb-3">
                <label class="form-label">Número <span class="text-danger">*</span></label>
                <input
                  type="text"
                  class="form-control"
                  formControlName="numero"
                  [class.is-invalid]="isFieldInvalid('numero')"
                  placeholder="Nº"
                />
                @if (isFieldInvalid('numero')) {
                  <div class="invalid-feedback">{{ getFieldError('numero') }}</div>
                }
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label">Bairro <span class="text-danger">*</span></label>
                <input
                  type="text"
                  class="form-control"
                  formControlName="bairro"
                  [class.is-invalid]="isFieldInvalid('bairro')"
                  placeholder="Nome do bairro"
                />
                @if (isFieldInvalid('bairro')) {
                  <div class="invalid-feedback">{{ getFieldError('bairro') }}</div>
                }
              </div>

              <div class="col-md-4 mb-3">
                <label class="form-label">Cidade <span class="text-danger">*</span></label>
                <input
                  type="text"
                  class="form-control"
                  formControlName="cidade"
                  [class.is-invalid]="isFieldInvalid('cidade')"
                  placeholder="Nome da cidade"
                />
                @if (isFieldInvalid('cidade')) {
                  <div class="invalid-feedback">{{ getFieldError('cidade') }}</div>
                }
              </div>

              <div class="col-md-2 mb-3">
                <label class="form-label">UF <span class="text-danger">*</span></label>
                <select
                  class="form-select"
                  formControlName="uf"
                  [class.is-invalid]="isFieldInvalid('uf')"
                >
                  <option value="">Selecione</option>
                  @for (uf of ufs; track uf) {
                    <option [value]="uf">{{ uf }}</option>
                  }
                </select>
                @if (isFieldInvalid('uf')) {
                  <div class="invalid-feedback">{{ getFieldError('uf') }}</div>
                }
              </div>

              <div class="col-md-12 mb-3">
                <label class="form-label">Complemento</label>
                <input
                  type="text"
                  class="form-control"
                  formControlName="complemento"
                  placeholder="Apto, bloco, etc..."
                />
              </div>
            </div>

            <!-- Botões -->
            <div class="d-flex justify-content-end gap-2 mt-4">
              <button
                type="button"
                class="btn btn-secondary"
                (click)="router.navigate(['/pacientes'])"
                [disabled]="loading"
              >
                Cancelar
              </button>
              <button type="submit" class="btn btn-primary" [disabled]="loading">
                @if (loading) {
                  <span class="spinner-border spinner-border-sm me-2"></span>
                }
                {{ isEditing ? 'Atualizar' : 'Cadastrar' }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
